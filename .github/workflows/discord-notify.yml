---
name: Discord New Post Notification

on:
  push:
    branches:
      - master
      - main
    paths:
      - '_posts/**'

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch last 2 commits to compare
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of new or modified files in _posts/
          CHANGED_FILES=$(git diff --name-status HEAD^ HEAD | grep "^[AM].*_posts/.*\.\(md\|html\)$" | awk '{print $2}')
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Parse post metadata and send to Discord
        if: steps.changed-files.outputs.files != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Loop through each changed post file
          echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
            if [ -n "$file" ]; then
              echo "Processing: $file"
              
              # Extract title (first line with "title:")
              TITLE=$(grep "^title:" "$file" | head -1 | sed 's/^title: *"\?\(.*\)"\?$/\1/' | sed 's/"//g')
              
              # Extract subtitle/description
              SUBTITLE=$(grep "^subtitle:" "$file" | head -1 | sed 's/^subtitle: *"\?\(.*\)"\?$/\1/' | sed 's/"//g')
              if [ -z "$SUBTITLE" ]; then
                SUBTITLE=$(grep "^description:" "$file" | head -1 | sed 's/^description: *"\?\(.*\)"\?$/\1/' | sed 's/"//g')
              fi
              
              # Extract excerpt if subtitle is empty
              if [ -z "$SUBTITLE" ]; then
                SUBTITLE=$(grep -A 5 "^---$" "$file" | tail -n +2 | grep -v "^---$" | grep -v "^title:" | grep -v "^tags:" | head -3 | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
              fi
              
              # Limit subtitle length
              if [ ${#SUBTITLE} -gt 200 ]; then
                SUBTITLE="${SUBTITLE:0:200}..."
              fi
              
              # Extract tags
              TAGS=$(grep "^tags:" "$file" | head -1 | sed 's/^tags: *\[\(.*\)\]$/\1/' | sed 's/, */ #/g')
              
              # Generate post URL (convert filename to URL)
              FILENAME=$(basename "$file")
              # Extract date and slug from filename (YYYY-MM-DD-slug.md)
              if [[ $FILENAME =~ ^([0-9]{4})-([0-9]{2})-([0-9]{2})-(.+)\.(md|html)$ ]]; then
                YEAR="${BASH_REMATCH[1]}"
                MONTH="${BASH_REMATCH[2]}"
                DAY="${BASH_REMATCH[3]}"
                SLUG="${BASH_REMATCH[4]}"
                POST_URL="https://pandaudit.com/${YEAR}/${MONTH}/${DAY}/${SLUG}"
              else
                POST_URL="https://pandaudit.com/blog"
              fi
              
              # Escape special characters for JSON
              TITLE=$(echo "$TITLE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
              SUBTITLE=$(echo "$SUBTITLE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
              
              # Create Discord embed JSON with engaging content
              JSON_PAYLOAD=$(cat <<DISCORD_JSON
          {
            "content": "ðŸ“¢ **New Insights from PANDAUDIT!** ðŸ“Š\\n\\nðŸ”” Fresh content alert! Check out our latest analysis on data analytics and automation.",
            "embeds": [{
              "title": "ðŸ“ $TITLE",
              "description": "$SUBTITLE\\n\\nðŸ’¡ *Ready to level up your data analytics skills? Dive into this comprehensive guide.*",
              "url": "$POST_URL",
              "color": 5814783,
              "fields": [
                {
                  "name": "ðŸ“š Topics Covered",
                  "value": "#$TAGS",
                  "inline": false
                },
                {
                  "name": "ðŸŽ¯ What You'll Learn",
                  "value": "Practical tips, real-world examples, and actionable insights for finance professionals",
                  "inline": false
                },
                {
                  "name": "ðŸ”— Read the Full Article",
                  "value": "[Click here to read now âžœ]($POST_URL)\\n\\nðŸ’¬ Share your thoughts and questions in this channel after reading!",
                  "inline": false
                }
              ],
              "footer": {
                "text": "PANDAUDIT - Data Analytics & Automation for Finance",
                "icon_url": "https://pandaudit.com/assets/img/avatar-icon.png"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
DISCORD_JSON
              )
              
              # Send to Discord
              if [ -n "$DISCORD_WEBHOOK" ]; then
                RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" \
                     -d "$JSON_PAYLOAD" \
                     "$DISCORD_WEBHOOK")
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                
                if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
                  echo "âœ… Successfully sent notification for: $TITLE"
                else
                  echo "âš ï¸ Failed to send notification. HTTP Code: $HTTP_CODE"
                  echo "Response: $(echo "$RESPONSE" | head -n-1)"
                fi
              else
                echo "âš ï¸ DISCORD_WEBHOOK_URL secret not set. Skipping Discord notification."
                echo "ðŸ“‹ To enable notifications, add DISCORD_WEBHOOK_URL to repository secrets."
                echo "ðŸ“‹ Would have sent: $TITLE"
              fi
              
              # Wait between posts to avoid rate limiting
              sleep 2
            fi
          done
